function arrayToBase64(e){for(var t="",o=e.length,n=0;n<o;++n)"number"==typeof e[n]&&(t+=String.fromCharCode(e[n]));return btoa(t)}function base64ToArray(e){for(var t=atob(e),o=[],n=t.length,a=0;a<n;)o.push(255&t.charCodeAt(a++));return o}function sendReqToBackend(e){basedData=arrayToBase64(e),packetReady=!1;var t=new XMLHttpRequest;t.open("POST",API_SERVER+"/packet/"+SESSION.uid,!0),t.setRequestHeader("Content-Type","text/plain"),t.setRequestHeader("X-FoolsSessionToken",localStorage.session),t.onreadystatechange=function(){if(this.readyState==XMLHttpRequest.DONE){if(200==this.status)for(curPacket=base64ToArray(t.responseText);curPacket.length%4!=0;)curPacket.push(0);else curPacket=[];var e=t.getResponseHeader("X-FoolsRefreshToken");e&&(localStorage.session=e);var o=t.getResponseHeader("X-FoolsProtocolVersion");o&&(curProtoVersion=parseInt(o)),isNaN(curProtoVersion)&&(curProtoVersion=0),200==this.status?packetReady=!0:setTimeout("packetReady=true",1e3)}},t.send(basedData)}function joyMakeExchange(){if(!window.joyCommBusy){if(window.joyCommBusy=!0,window.joyRecv<0&&(window.joyRecv+=4294967296),window.joySend<0&&(window.joySend+=4294967296),window.joyExchDelay=50,curState==SHF)3192919551==window.joySend&&(curState=SHS);else if(curState==SHS)4290662421==window.joySend&&(curState=SR1);else if(curState==SR1)window.joyRecv=983061,curState=SR2;else if(curState==SR2)window.joyRecv=539104055,curState=SRL;else if(curState==SRL)packetLen=window.joySend,curPacket=[],curState=SRD;else if(curState==SRD){var e=window.joySend;curPacket.push(e>>0&255),curPacket.push(e>>8&255),curPacket.push(e>>16&255),curPacket.push(e>>24&255),packetLen--,0==packetLen&&(sendReqToBackend(curPacket),curState=SPP),window.joyExchDelay=2}else if(curState==SPP)packetReady?0==curPacket.length||curPacket.length%4!=0?(window.joyRecv=3735936685,curState=SHF):(window.joyRecv=3402562254,packetLen=curPacket.length/4,curState=SWL):window.joyRecv=4277194432;else if(curState==SWL)window.joyRecv=packetLen+16777216*curProtoVersion,curState=SWR;else if(curState==SWR){for(var t=IodineGUI.Iodine.IOCore.cpu.registers[4]-33554432,o=0;o<curPacket.length;o++)IodineGUI.Iodine.IOCore.memory.externalRAM[t+o]=curPacket[o];IodineGUI.Iodine.IOCore.cpu.registers[5]=1;var n=curPacket[0]<<0;n|=curPacket[1]<<8,n|=curPacket[2]<<16,n|=curPacket[3]<<24,window.joyRecv=n,curState=SHF}window.joyExch=2}}function joyExchangeLoop(){joyMakeExchange(),setTimeout(joyExchangeLoop,window.joyExchDelay)}function prepareEmu(){IodineGUI&&IodineGUI.Iodine?(IodineGUI.Iodine.attachBIOS(BIOS_DATA),$(".f-gb-button").each((function(e,t){t.addEventListener("mousedown",(function(e){e.preventDefault(),IodineGUI.Iodine.keyDown(parseInt(e.target.getAttribute("data-btn")))})),t.addEventListener("touchstart",(function(e){e.preventDefault(),IodineGUI.Iodine.keyDown(parseInt(e.target.getAttribute("data-btn")))})),t.addEventListener("mouseup",(function(e){e.preventDefault(),IodineGUI.Iodine.keyUp(parseInt(e.target.getAttribute("data-btn")))})),t.addEventListener("touchend",(function(e){e.preventDefault(),IodineGUI.Iodine.keyUp(parseInt(e.target.getAttribute("data-btn")))}))})),addEvent("change",document.getElementById("rom_load"),(function(e){document.getElementById("rom_load_inp").style.display="none",setTimeout((function(){startEmu()}),100)}))):setTimeout(prepareEmu,50)}function startEmu(){document.querySelector("#emulator_target").width=480,document.querySelector("#emulator_target").height=320,document.querySelector("#play").click(),document.querySelector("#client-before").style.display="none",document.querySelector("#client-running").style.display=""}window.joyExch=0,window.joyRecv=0,window.joySend=0,window.joyExchDelay=50,window.joyCommBusy=!0,SHF=1,SHS=2,SR1=3,SR2=4,SRL=5,SRD=6,SPP=7,SWL=8,SWR=9,curState=SHF,packetLen=0,curPacket=[],curProtoVersion=0,packetReady=!1,joyExchangeLoop(),window.onPingCompleted=function(e){if(SESSION.logged_in){var t=new XMLHttpRequest;t.onload=function(){200==this.status&&(BIOS_DATA=new Uint8Array(this.response),prepareEmu())},t.open("GET","./assets/bios.bin?"+Math.random(),!0),t.responseType="arraybuffer",t.overrideMimeType("text/plain; charset=x-user-defined"),t.send(null)}else modalMessageWithRedirect("You are not logged in.","index.html")};